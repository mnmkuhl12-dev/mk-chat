<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M & K Chat â€” Servers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    #messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      text-align: left;
    }
    .hidden { display: none; }
    #timer { font-size: 20px; margin-bottom: 10px; }
  </style>
</head>
<body>

  <!-- PASSWORD SCREEN -->
  <div id="login">
    <h2>Enter Password</h2>
    <input id="pass" type="password" placeholder="Password">
    <br>
    <button onclick="login()">Enter</button>
  </div>

  <!-- SERVER SELECTION -->
  <div id="serverSelect" class="hidden">
    <h2>Select a Server</h2>
    <button onclick="selectServer('server1_messages')">Server 1</button>
    <button onclick="selectServer('server2_messages')">Server 2</button>
  </div>

  <!-- USER SELECTION -->
  <div id="choose" class="hidden">
    <h2>Who are you?</h2>
    <button onclick="setUser('M')">M</button>
    <button onclick="setUser('K')">K</button>
  </div>

  <!-- CHAT -->
  <div id="chat" class="hidden">
    <h2>M & K Chat</h2>
    <div id="timer">Next reset in 35:00</div>
    <div id="messages"></div>
    <input id="msg" placeholder="Type a message" onkeydown="if(event.key==='Enter') sendMessage()">
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "PASTE_YOUR_API_KEY_HERE",
    authDomain: "mk-chat-f9a10.firebaseapp.com",
    projectId: "mk-chat-f9a10",
    storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
    messagingSenderId: "PASTE_YOUR_SENDER_ID_HERE",
    appId: "PASTE_YOUR_APP_ID_HERE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- ELEMENTS ---
  const loginDiv = document.getElementById("login");
  const serverDiv = document.getElementById("serverSelect");
  const chooseDiv = document.getElementById("choose");
  const chatDiv = document.getElementById("chat");
  const passInput = document.getElementById("pass");
  const messagesDiv = document.getElementById("messages");
  const msgInput = document.getElementById("msg");
  const timerDiv = document.getElementById("timer");

  const PASSWORD = "1234"; // Change as needed
  let user = "";
  let otherUser = "";
  let serverCollection = "";
  const RESET_INTERVAL = 35 * 60 * 1000; // 35 minutes in ms
  let resetTime = Date.now() + RESET_INTERVAL;

  // --- PASSWORD ---
  window.login = function() {
    if(passInput.value === PASSWORD){
      loginDiv.classList.add("hidden");
      serverDiv.classList.remove("hidden");
    } else {
      alert("Wrong password");
    }
  };

  // --- SERVER SELECTION ---
  window.selectServer = function(collectionName){
    serverCollection = collectionName;
    serverDiv.classList.add("hidden");
    chooseDiv.classList.remove("hidden");
    checkReset(); // check if messages need reset
  };

  // --- USER SELECTION ---
  window.setUser = function(u){
    user = u;
    otherUser = u === "M" ? "K" : "M";
    chooseDiv.classList.add("hidden");
    chatDiv.classList.remove("hidden");
    startListening();
    startTimer();
  };

  // --- SEND MESSAGE ---
  window.sendMessage = async function(){
    if(!msgInput.value.trim()) return;
    await addDoc(collection(db, serverCollection), {
      user: user,
      text: msgInput.value,
      time: Date.now()
    });
    msgInput.value = "";
  };

  // --- LISTEN TO SERVER MESSAGES ---
  function startListening(){
    const q = query(collection(db, serverCollection), orderBy("time"));
    onSnapshot(q, snapshot => {
      messagesDiv.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.user === user || data.user === otherUser){
          messagesDiv.innerHTML += `<div><b>${data.user}:</b> ${data.text}</div>`;
        }
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // --- TIMER & RESET ---
  function startTimer(){
    setInterval(()=>{
      const now = Date.now();
      const diff = resetTime - now;
      if(diff <= 0){
        resetMessages();
        resetTime = Date.now() + RESET_INTERVAL;
      }
      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000)/1000);
      timerDiv.textContent = `Next reset in ${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    },1000);
  }

  async function resetMessages(){
    const querySnapshot = await getDocs(collection(db, serverCollection));
    querySnapshot.forEach(async (docSnap)=>{
      await deleteDoc(doc(db, serverCollection, docSnap.id));
    });
    messagesDiv.innerHTML = "";
  }

  function checkReset(){
    // Initialize resetTime for new server
    resetTime = Date.now() + RESET_INTERVAL;
  }

</script>

</body>
</html>
