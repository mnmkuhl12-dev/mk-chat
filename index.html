<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M & K Chat â€” Servers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#111; color:white; font-family:Arial,sans-serif; text-align:center; margin:0; padding:20px; }
    input, button { padding:10px; margin:5px; font-size:16px; }
    #messages { height:300px; overflow-y:auto; border:1px solid #444; padding:10px; margin-bottom:10px; text-align:left; }
    .hidden { display:none; }
    #timer { font-size:20px; margin-bottom:10px; }
  </style>
</head>
<body>

  <!-- PASSWORD SCREEN -->
  <div id="login">
    <h2>Enter Password</h2>
    <input id="pass" type="password" placeholder="Password">
    <br>
    <button onclick="login()">Enter</button>
  </div>

  <!-- SERVER SELECTION -->
  <div id="serverSelect" class="hidden">
    <h2>Select a Server</h2>
    <button onclick="selectServer('server1_messages')">Server 1</button>
    <button onclick="selectServer('server2_messages')">Server 2</button>
  </div>

  <!-- USER SELECTION -->
  <div id="choose" class="hidden">
    <h2>Who are you?</h2>
    <button onclick="setUser('M')">M</button>
    <button onclick="setUser('K')">K</button>
  </div>

  <!-- CHAT -->
  <div id="chat" class="hidden">
    <h2>M & K Chat</h2>
    <div id="timer">Next reset in 35:00</div>
    <div id="messages"></div>
    <input id="msg" placeholder="Type a message" onkeydown="if(event.key==='Enter') sendMessage()">
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyBT7sj4JDmLXuJzyZVe3wQx9nqqdrXgUB0",
    authDomain: "mk-chat-f9a10.firebaseapp.com",
    projectId: "mk-chat-f9a10",
    storageBucket: "mk-chat-f9a10.firebasestorage.app",
    messagingSenderId: "609608804648",
    appId: "1:609608804648:web:79e5aae8f3a5851b4cc81d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- ELEMENTS ---
  const loginDiv = document.getElementById("login");
  const serverDiv = document.getElementById("serverSelect");
  const chooseDiv = document.getElementById("choose");
  const chatDiv = document.getElementById("chat");
  const passInput = document.getElementById("pass");
  const messagesDiv = document.getElementById("messages");
  const msgInput = document.getElementById("msg");
  const timerDiv = document.getElementById("timer");

  const PASSWORD = "1234"; // change if needed
  let user = "";
  let serverCollection = "";
  const RESET_INTERVAL = 35 * 60 * 1000; // 35 minutes

  // --- LOGIN ---
  window.login = function() {
    if(passInput.value === PASSWORD){
      loginDiv.classList.add("hidden");
      serverDiv.classList.remove("hidden");
    } else {
      alert("Wrong password");
    }
  };

  // --- SERVER SELECTION ---
  window.selectServer = async function(collectionName){
    serverCollection = collectionName;
    serverDiv.classList.add("hidden");
    chooseDiv.classList.remove("hidden");

    // --- initialize/reset timer in server_info doc ---
    const infoRef = doc(db, collectionName + "_info", "meta");
    const infoSnap = await getDoc(infoRef);
    if(!infoSnap.exists()){
      await setDoc(infoRef, { resetTime: Date.now() + RESET_INTERVAL });
    }
  };

  // --- USER SELECTION ---
  window.setUser = function(u){
    user = u;
    chooseDiv.classList.add("hidden");
    chatDiv.classList.remove("hidden");
    startListening();
    startTimer();
  };

  // --- SEND MESSAGE ---
  window.sendMessage = async function(){
    if(!msgInput.value.trim()) return;
    await addDoc(collection(db, serverCollection), {
      user: user,
      text: msgInput.value,
      time: Date.now()
    });
    msgInput.value = "";
  };

  // --- LISTEN TO SERVER MESSAGES ---
  function startListening(){
    const q = query(collection(db, serverCollection), orderBy("time"));
    onSnapshot(q, snapshot => {
      messagesDiv.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        messagesDiv.innerHTML += `<div><b>${data.user}:</b> ${data.text}</div>`;
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // --- TIMER & RESET SYNCED ---
  async function startTimer(){
    const infoRef = doc(db, serverCollection + "_info", "meta");

    onSnapshot(infoRef, async (docSnap)=>{
      if(!docSnap.exists()) return;
      let resetTime = docSnap.data().resetTime;

      const interval = setInterval(async ()=>{
        const now = Date.now();
        let diff = resetTime - now;

        if(diff <= 0){
          // RESET messages
          const msgs = await getDocs(collection(db, serverCollection));
          msgs.forEach(async (d)=>{
            await deleteDoc(doc(db, serverCollection, d.id));
          });
          // update resetTime for everyone
          resetTime = Date.now() + RESET_INTERVAL;
          await setDoc(infoRef, { resetTime: resetTime });
        }

        diff = resetTime - Date.now();
        const minutes = Math.floor(diff/60000);
        const seconds = Math.floor((diff%60000)/1000);
        timerDiv.textContent = `Next reset in ${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
      }, 1000);
    });
  }

</script>

</body>
</html>
